#### React异步渲染

把渲染/更新过程拆分为小块任务，通过合理的调度机制来控制时间。

* 拆什么？什么不能拆？

把渲染/更新拆分为2个阶段：

> 1.reconciliation阶段
>
> 2.commit阶段

reconciliation阶段比较出DOM变化，commit阶段将这些变化实施到DOM上。

* 怎么拆

按照virtual DOM树的结构来拆分。

Fiber树的结构和virtual DOM树的拆分粒度一致，只不过Fiber树是由fiber节点构成。

Fiber树是一个基于单链表的树结构，而virtual DOM树是一个自上而下的简单树结构。

每个Fiber节点就代表一个工作单元。工作循环中，每次处理一个工作单元（一个Fiber），处理完可以中断/挂起整个工作循环。

* 如何调度任务

两部分：

\- 工作循环

\- 优先级机制

工作循环是基本的任务调度机制，工作循环中每次处理一个任务，处理完毕有一次喘息机会。

优先级机制用来处理突发事件与优化次序：

\- 到commit阶段了，提高优先级

\- 高优任务做一半出错了，给降一下优先级

\- 抽空关注一下低优任务，别给饿死了

\- 如果对应DOM节点此刻不可见，给降到最低优先级

这些策略用来动态调整任务调度，是工作循环的辅助机制，最先做最重要的事情。

* 如何中断/断点恢复？

中断：检查当前正在处理的工作单元，保存当前成果（`firstEffect`，`lastEffect`），修改tag标记，迅速收尾并再开一个`requestIdleCallback`，下次有机会再做。

断点恢复：下次再处理到该工作单元时，如果tag是被打断的任务，接着做未完成的部分或重做。

* 如何收集任务结果

通过每个节点更新结束时__向上归并effect list__来收集任务结果，reconciliation结束后，根节点的effect list里记录了包括DOM change在内的所有side effect。